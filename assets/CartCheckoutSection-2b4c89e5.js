import{r as l,b as _,u as G,d as P,l as U,j as e,L as J,Z as W,Y,a3 as H}from"./index-131eb30e.js";import{u as K}from"./usePriceToTw-9c079645.js";import{u as Q,a as X,V as E}from"./ValidationSelectGroup-660f4aa2.js";import{V as m}from"./ValidationInputGroup-7d63d4fc.js";import{k as ee,l as se}from"./index.esm-709242c1.js";import{k as ae}from"./clientApis-016cf649.js";import{u as te}from"./useMessage-aafe73ad.js";import{S as u}from"./sweetalert2.all-c223cf0e.js";import{u as le}from"./useDispatch-4bd35c40.js";import"./iconBase-b99dbde1.js";import"./react-toastify.esm-dde1cf43.js";const je=()=>{var w,T;const[o,f]=l.useState([]);let{state:c}=_();const p=G(s=>s.coupon),{handlePriceToTw:x}=K(),[j,h]=l.useState(!1),{inputToastMessage:g}=te(),C=le(),A=P(),[re,v]=l.useState(!1),[oe,k]=l.useState(""),{register:i,handleSubmit:L,formState:{errors:n},getValues:N,control:V,reset:q}=Q({defaultValues:{email:"",name:"",tel:"",address:"",city:"",area:""},mode:"onTouched"}),[d,B]=l.useState([]);l.useEffect(()=>{p.total?f((c==null?void 0:c.carts)||[]):f([])},[c,p]);const O=async s=>{var a;try{h(!0);const{name:t,email:$,tel:Z,address:z,city:D,area:M}=s,R={data:{user:{name:t,email:$,tel:Z,address:D+M+z}}};u.fire({title:"確認送出?",text:"配送資料填寫錯誤可能導致一些問題產生，確認寄送資料正確請按下確認",icon:"question",confirmButtonColor:"#111c30",cancelButtonColor:"#b2bec3",confirmButtonText:"確認",cancelButtonText:"取消",showCancelButton:!0,showCloseButton:!0,showLoaderOnConfirm:!0,preConfirm:async()=>{try{return await ae(R)}catch(r){u.showValidationMessage(`請求失敗： ${r}`)}},allowOutsideClick:()=>!u.isLoading()}).then(r=>{var S,F;r.isConfirmed?(u.fire("成功",(F=(S=r==null?void 0:r.value)==null?void 0:S.data)==null?void 0:F.message,"success"),h(!1),C(W()),C(Y()),H.purge("coupon"),q(),v(!0),k(r.value.data.orderId),A("/cart/payment",{state:r.value.data.orderId})):h(!1)})}catch(t){g((a=t==null?void 0:t.response)==null?void 0:a.data),v(!0)}},y=l.useCallback(async()=>{var s;try{const a="https://raw.githubusercontent.com/donma/TaiwanAddressCityAreaRoadChineseEnglishJSON/master/CityCountyData.json",t=await U.get(a);B(t.data)}catch(a){g((s=a==null?void 0:a.response)==null?void 0:s.data)}},[]);l.useEffect(()=>{y()},[y]);const b=d.filter(s=>s.CityName===N("city")),I=X({control:V});return l.useEffect(()=>{},[I]),e.jsx("div",{className:"mb-3 pb-3",children:e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-12 col-lg-8  pt-2 pb-3",children:[e.jsx("h4",{className:"border-bottom border-2 border-primary fs-5 pb-2",children:"配送資料"}),e.jsx("form",{onSubmit:L(O),children:e.jsxs("fieldset",{children:[e.jsx("legend",{children:"填寫寄送者資訊"}),e.jsx(m,{id:"email",type:"email",errors:n,register:i,groupClass:"mt-3",labelText:"Email",labelClass:"form-label mb-1",inputClass:"form-control",placeholder:"請輸入電子郵件",rules:{required:{value:!0,message:"此欄位必填"},pattern:{value:/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,message:"未符合電子郵箱格式"}}}),e.jsx(m,{id:"name",type:"text",errors:n,register:i,groupClass:"mt-3",labelText:"聯絡人姓名",labelClass:"form-label mb-1",inputClass:"form-control",placeholder:"請輸入聯絡人姓名",rules:{required:{value:!0,message:"此欄位必填"},pattern:{value:/^[\u4E00-\u9FFF]*·*[\u4E00-\u9FFF]*$/,message:"請填寫中文姓名"}}}),e.jsx(m,{id:"tel",type:"tel",errors:n,register:i,groupClass:"mt-3",labelText:"聯絡手機",labelClass:"form-label mb-1",inputClass:"form-control",placeholder:"請輸入聯絡手機",rules:{required:{value:!0,message:"此欄位必填"},pattern:{value:/^(0|\+?886)9\d{8}$/,message:"格式錯誤，請使用 09 或 886 前綴"}}}),e.jsxs(E,{id:"city",errors:n,register:i,labelText:"縣市",groupClass:"mt-3",labelClass:"form-label mb-1",selectClass:"form-control",rules:{required:{value:!0,message:"請選擇縣市"}},defaultValue:"",children:[e.jsx("option",{value:"",disabled:!0,children:"--請選擇縣市--"}),d==null?void 0:d.map(s=>e.jsx("option",{value:s.CityName,children:s.CityName},s.CityName))]}),e.jsxs(E,{id:"area",errors:n,register:i,labelText:"鄉/鎮/市/區",groupClass:"mt-3",labelClass:"form-label mb-1",selectClass:"form-control",defaultValue:"",rules:{required:{value:!0,message:"請選擇鄉鎮市區"}},disabled:!N("city"),children:[e.jsx("option",{value:"",disabled:!0,children:"--請選擇鄉鎮市區--"}),(T=(w=b==null?void 0:b[0])==null?void 0:w.AreaList)==null?void 0:T.map(s=>e.jsx("option",{value:s.AreaName,children:s.AreaName},s.AreaName))]}),e.jsx(m,{id:"address",type:"text",errors:n,register:i,groupClass:"mt-3",labelText:"地址",labelClass:"form-label mb-1",inputClass:"form-control",placeholder:"請輸入配送地址",rules:{required:{value:!0,message:"此欄位必填"},pattern:{value:/^[\u4e00-\u9fa5_(0-9|\uFF10-\uFF19)-]*$/,message:"請輸入地址"}}}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center pt-3",children:[e.jsxs(J,{to:"/cart",role:"button",className:"d-inline-block btn btn-secondary link-primary-hover",children:[e.jsx(ee,{className:"icon me-1"}),"回到上一頁"]}),e.jsx("input",{type:"submit",className:"btn btn-primary btn-primary-hover ",value:j?"表單處理中":"確認送出",style:{width:"120px"},disabled:j})]})]})})]}),e.jsxs("div",{className:"col-12 col-lg-4 border border-2 py-2",children:[e.jsx("h4",{className:"border-bottom border-2 border-primary fs-5 pb-2",children:"購物車明細"}),o!=null&&o.length?o==null?void 0:o.map(s=>{var a,t;return e.jsx("div",{children:e.jsxs("div",{className:"row mt-3 border-bottom border-2 pb-3",children:[e.jsx("div",{className:"col-3",children:e.jsx("img",{src:s.product.imageUrl,alt:s.product.title,title:s.product.title,style:{width:"75px",height:"75px"}})}),e.jsx("div",{className:"col-7",children:e.jsxs("div",{className:"d-flex justify-content-center align-items-start flex-column",children:[e.jsx("span",{children:s.product.title}),e.jsxs("span",{className:"text-muted fs-7",children:["總價：NT",x(s.total)]})]})}),e.jsx("div",{className:"col-2",children:e.jsxs("div",{className:"d-flex justify-content-center align-items-start flex-column ",children:[e.jsxs("span",{children:["x ",s.qty]}),e.jsx("span",{className:"opacity-0 fs-7",children:"|"})]})}),e.jsx("div",{className:"col-8",children:(a=s==null?void 0:s.coupon)!=null&&a.code?e.jsxs("span",{className:"mt-1 text-danger float-start d-flex align-items-center",children:[e.jsx(se,{className:"icon me-1"}),"使用優惠：",(t=s==null?void 0:s.coupon)==null?void 0:t.code]}):null}),e.jsx("div",{className:"col-4",children:e.jsxs("span",{className:"mt-1 fw-border float-end",children:["NT",x(s.final_total)]})})]})},s.id)}):"購物車內無商品",e.jsx("div",{className:"border-bottom border-2 border-primary pt-4 pb-2",children:e.jsxs("div",{className:"row ",children:[e.jsx("div",{className:"col-6 text-start",children:e.jsx("span",{className:"fs-3 fw-bolder",children:"總價"})}),e.jsx("div",{className:"col-6 text-end",children:e.jsxs("span",{className:"fs-3 fw-bolder",children:["NT",x(p.finalTotal)]})})]})})]})]})})};export{je as default};
